<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script defer src="/__/firebase/8.7.1/firebase-app.js"></script>
    <script defer src="/__/firebase/8.7.1/firebase-auth.js"></script>
    <script defer src="/__/firebase/8.7.1/firebase-database.js"></script>
    <script defer src="/__/firebase/init.js"></script>
    <script
    src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js">
    </script>
    <link rel="stylesheet" type="text/css"
    href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" />
    <style type="text/css">
        .dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }
        .light-mode {
            color: #333;
            background-color: #f0f0f0;
        }
        .container{
            display: flex;
        }
        .style-0 {
            fill: #e200ff;
            fill-opacity: 0;
            stroke-width: 2px;
            stroke: #e200ff;
        }
        .style-1 {
            fill: #00b72b;
            fill-opacity: 0;
            stroke-width: 2px;
            stroke: #00b72b;
        }
        .style-2 {
            fill: #b2b700;
            fill-opacity: 0;
            stroke-width: 2px;
            stroke: #b2b700;
        }
        #history {
            background-color: #ffffff;
            border:solid;
            border-width: 5px;
            height: 100px;
            overflow-y: auto;
            flex-basis: auto;
        }
    </style>
</head>
<body class="light-mode">
    <div class="container">
        <div style="flex-grow:1; flex-direction:column">
            <div>History</div>
            <div id="history"></div>
            <button id="infoButton">Check info</button>
        </div>
        <div style="flex-grow:4" id="visualization"></div>
    </div>
    <script type="text/javascript">
        let newest;
        let infoButton = document.getElementById('infoButton');
        infoButton.addEventListener('click', () => {
            let app = firebase.app();
            var ref = app.database().ref('stations').child('st001/info');
            let container = document.getElementById('history');
            ref.on("value", function(snapshot) {
                let data = snapshot.val();
                let last = null;
                let now = Date.now();
                for(let [key, o] of Object.entries(data)){
                    if(o.flag == 'up') last = o;
                }
                console.log(newest)
                if(newest.lux < 50){
                    container.innerHTML = "今は灯がついていない<br>" + container.innerHTML;
                }
                else {
                    let time = now - last.time;
                    let hour = Math.floor(time / 60 / 60 / 1000);
                    let minute = Math.floor((time - hour * 60 * 1000) / 60 / 1000);
                    let second = Math.floor((time - hour * 60 * 60 * 1000 - minute * 60 * 1000) / 1000);
                    container.innerHTML = "<div>今までの灯がついている時間: " + (hour>0?(hour + "時"):"") + (minute>0?(minute+ "分"):"") + (second>0?(second + "秒"):"") + "</div>" + container.innerHTML;
                }
            });
        });
        document.addEventListener('DOMContentLoaded', function() {
        let app = firebase.app();
        let container = document.getElementById('visualization');
        let names = ['lux'];
        let dataset = new vis.DataSet();
        let groups = new vis.DataSet();
        groups.add({
            id: 0,
            content: names[0],
            className: 'style-0',
            options: {
                yAxisOrientation: 'left',
                interpolation: false,
                drawPoints: { size: 2 }
            }
        });
        groups.add({
            id: 1,
            content: 'light off state',
            className: 'style-1',
            options: {
                yAxisOrientation: 'left',
                interpolation: false,
                drawPoints: { size: 2 }
            }
        });

        function lightOffState(now, until) {
            for (let i = now; i <= until; i+=5000) {
                let value = 50;
                dataset.add({ x: i, y: value, group: 1 });
                }
        }

        let date = new Date();
        lightOffState(Date.now() - 5 * 60 * 1000, Date.now() + 10 * 60 * 1000);
        let options = {
            dataAxis: { showMinorLabels: true, alignZeros: false },
            width: '100%',
            height: '550px',
            moveable: false,
            legend: { left: { position: "top-right" } },
            start: date.setMinutes(date.getMinutes() - 5),
            end: date.setMinutes(date.getMinutes() + 15)
        };
        let graph2d = new vis.Graph2d(container, dataset, groups, options);
        var ref = app.database().ref('stations').child('st001/lux');
        ref.limitToLast(100).on('child_added', function(snapshot) {
            var newData = snapshot.val();
            addItem(newData.timestamp, newData.lux, 0);
            newest = newData;
            if(newest.lux > 50){ document.body.classList.toggle('ligth-mode'); } 
            else { document.body.classList.toggle('dark-mode');}
            let now = new Date();
            lightOffState(Date.now() + 10 * 60 * 1000, Date.now() + 10 * 60 * 1000);
            graph2d.setWindow(now.setMinutes(now.getMinutes() - 5), now.setMinutes(now.getMinutes() + 10), {animation: false});
        });
        function addItem(timestamp, value, g) {
            itm = { x: new Date(timestamp), y: Number(value), group: g };
            dataset.add(itm);
        }
        });
    </script>

</body>
</html>
